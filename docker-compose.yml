volumes:
    n8n_storage:

x-shared: &n8n
    restart: always
    image: docker.n8n.io/n8nio/n8n
    environment:
        - DB_TYPE=postgresdb
        - DB_POSTGRESDB_HOST=postgre
        - DB_POSTGRESDB_PORT=5432
        - DB_POSTGRESDB_DATABASE=n8n
        - DB_POSTGRESDB_USER=${POSTGRES_USER}
        - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}
        - EXECUTIONS_MODE=queue
        - QUEUE_BULL_REDIS_HOST=redis
        - QUEUE_BULL_REDIS_PASSWORD=${REDIS_PASSWORD}
        - QUEUE_HEALTH_CHECK_ACTIVE=true
        - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
        - N8N_RUNNERS_ENABLED=true
        - OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS=true
    links:
        - postgre
        - redis
    volumes:
        - ./data/n8n:/home/node/.n8n
    depends_on:
        redis:
            condition: service_healthy
        postgre:
            condition: service_healthy

services:
    redis:
        image: redis:latest
        ports:
            - "6379:6379"
        volumes:
            - ./data/redis:/data
            - ./data/redis/log:/var/log/redis
            - ./conf/redis/redis.conf:/usr/local/etc/redis/redis.conf
        command: --requirepass ${REDIS_PASSWORD}
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5

    minio:
        image: minio:latest
        ports:
            - "9000:9000"
            - "9001:9001"
        volumes:
            - ./data/minio:/data
        environment:
            MINIO_ROOT_USER: "${MINIO_ROOT_USER}"
            MINIO_ROOT_PASSWORD: "${MINIO_ROOT_PASSWORD}"

    mysql:
        image: mysql:latest
        ports:
            - "3306:3306"
        volumes:
            - ./data/mysql:/var/lib/mysql
            - ./conf/mysql:/etc/mysql/conf.d
        environment:
            MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD}"

    chroma:
        image: chroma:latest
        environment:
            - IS_PERSISTENT=TRUE
        volumes:
            - ./data/chroma:/chroma/chroma/
        ports:
            - 10001:8000

    nginx:
        image: nginx:latest
        network_mode: host
        volumes:
            - ./data/nginx/log:/var/log/nginx
            - ./conf/nginx:/etc/nginx

    litellm:
        build:
            context: .
            args:
                target: runtime
        image: ghcr.io/berriai/litellm:main-latest
        ports:
            - "4000:4000"
        volumes:
            - ./conf/litellm/config.yaml:/app/config.yaml
        command:
            [
                "--config",
                "/app/config.yaml",
                "--port",
                "4000",
                "--num_workers",
                "1",
            ]
        environment:
            LITELLM_AZURE_API_BASE: "${LITELLM_AZURE_API_BASE}"
            LITELLM_AZURE_API_KEY: "${LITELLM_AZURE_API_KEY}"
            LITELLM_AZURE_DEPLOYMENT: "${LITELLM_AZURE_DEPLOYMENT}"
            LITELLM_MASTER_KEY: "${LITELLM_MASTER_KEY}"
            UI_USERNAME: "${LITELLM_UI_USERNAME}"
            UI_PASSWORD: "${LITELLM_UI_PASSWORD}"

    postgre:
        image: postgre:latest
        shm_size: 128mb
        volumes:
            - ./data/postgre/data:/var/lib/postgresql/data/pgdata
        ports:
            - 5432:5432
        environment:
            POSTGRES_USER: "${POSTGRES_USER}"
            POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
            PGDATA: "/var/lib/postgresql/data/pgdata"
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
            interval: 10s
            timeout: 5s
            retries: 5

    static:
        restart: no
        image: joseluisq/static-web-server:2-alpine
        ports:
            - 80:80
        environment:
            - SERVER_ROOT=/var/public
            - SERVER_CONFIG_FILE=/etc/config.toml
        volumes:
            - ./conf/static/public:/var/public
            - ./conf/static/config.toml:/etc/config.toml

    sftp:
        restart: no
        platform: linux/x86_64
        image: sftp
        ports:
            - "2022:22"
        volumes:
            - ./conf/sftp/users.conf:/etc/sftp/users.conf:ro
        privileged: true

    aliyundrive:
        image: messense/aliyundrive-webdav
        restart: no
        ports:
        - '10002:8080'
        volumes:
            - ./data/aliyundrive:/etc/aliyundrive-webdav/
        environment:
            WEBDAV_AUTH_USER: "${ALIYUNDRIVER_WEBDAV_AUTH_USER}"
            WEBDAV_AUTH_PASSWORD: "${ALIYUNDRIVER_WEBDAV_AUTH_PASSWORD}"
            REFRESH_TOKEN: "${ALIYUNDRIVER_REFRESH_TOKEN}"

    n8n:
        <<: *n8n
        ports:
        - 5678:5678
        healthcheck:
            test: ["CMD", "curl", "--fail", "http://localhost:5678/healthz"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s

    n8n-worker:
        <<: *n8n
        command: worker
        depends_on:
        - n8n

    crawl4ai: # Or your chosen service
        image: unclecode/crawl4ai:latest
        ports:
        - 11235:11235
        volumes:
        - ./conf/crawl4ai/config.yml:/app/config.yml
